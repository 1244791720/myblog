<link href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- jQuery (Bootstrap 的所有 JavaScript 插件都依赖 jQuery，所以必须放在前边) -->
<script src="https://cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<!-- 加载 Bootstrap 的所有 JavaScript 插件。你也可以根据需要只加载单个插件。 -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/js/bootstrap.min.js"></script>
<!-- Vue -->
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="../js/common.js"></script>
<table id="app" class="my-table table table-hover  table-bordered table-striped">
    <h1>文章管理</h1>
    <thead>
    <tr>
        <th>ID</th>
        <th>标题</th>
        <th>类型</th>
        <th>作者</th>
        <th>删除</th>
        <th>修改</th>
        <th>修改封面</th>
    </tr>
    </thead>
    <tbody>
    <tr v-for="article in articles">
        <td>{{article.Id}}</td>
        <td>{{article.ArticleTitle}}</td>
        <td>{{article.ArticleType}}</td>
        <td>{{article.ArticleAuthor}}</td>
        <td><span :article-id="article.Id" class="glyphicon glyphicon-trash" style="cursor:hand;"
                  onclick="deleteArticle(this)"></span></td>
        <td><span :article-id="article.Id" data-toggle="modal" data-target="#myModal" onclick="echoFormData(this)"
                  class="glyphicon glyphicon-pencil" style="cursor:hand"></span></td>
        <td><span :article-id="article.Id" class="glyphicon glyphicon-pencil" onclick="updateCover(this)" style="cursor:hand;" data-toggle="modal"
                  data-target="#coverModal"></span></td>
    </tr>
    </tbody>
</table>

<!--修改模态框-->
<!-- Modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title" id="myModalLabel">修改文章属性</h4>
            </div>
            <form class="articleForm" action="" method="post" enctype="multipart/form-data"
                  target="nm_iframe">
                <div class="modal-body">
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="article_title">文章标题</label>
                            <input name="article_title" class="form-control" id="article_title"
                                   placeholder="标题">
                        </div>
                        <div class="form-group">
                            <label for="article_simple_content">简短描述</label>
                            <input name="article_simple_content" class="form-control" id="article_simple_content"
                                   placeholder="描述">
                        </div>
                        <div class="form-group">
                            <label for="article_author">作者</label>
                            <input name="article_author" class="form-control" id="article_author" placeholder="作者">
                        </div>
                        <div class="form-group">
                            <label for="type_id">文章类型</label>
                            <!--todo 后端生成文章类型列表-->
                            <select name="type_id" id="type_id">
                                <option value="1">技术杂谈</option>
                                <option value="2">Java</option>
                                <option value="3">GO</option>
                                <option value="4">JavaScript</option>
                                <option value="5">前端</option>
                            </select>
                        </div>
                        <!--<div class="form-group">-->
                        <!--<label for="exampleInputFile">封面</label>-->
                        <!--<input type="file" name="coverImage" id="exampleInputFile">-->
                        <!--<p class="help-block">添加文章的封面</p>-->
                        <!--</div>-->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                    <button type="button" id="saveButton" class="btn btn-primary" onclick="modifyArticle()">保存</button>
                </div>
            </form>
            <iframe id="nm_iframe" name="nm_iframe" style="display:none;"></iframe>
        </div>
    </div>
</div>
<!--修改单个封面图Modal-->
<!-- Modal -->
<div class="modal fade" id="coverModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title" id="coverModalLabel">修改文章封面图</h4>
            </div>
            <form class="articleForm" action="../updateOneArticleCover" method="post" enctype="multipart/form-data"
                  target="nm_iframe">
                <div class="modal-body">
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="article_cover">文章封面</label>
                            <input type="file" name="article_cover" class="form-control" id="article_cover">
                            <input type="hidden" name="id" value="" class="form-control">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-default" onclick="hideCoverModal()"> 提交</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script type="application/javascript">
    let app = new Vue({
        el: '#app',
        data: {
            articles: [],
        },
        methods: {},
    })

    // 初始化文章数据 第0页五条数据
    function initArticle(app) {
        // ajax 请求
        //发送get请求
        let limit = 5
        let offset = 0
        let param = `?limit=${limit}&offset=${offset}`
        console.log("param", param)
        $.get(getPageArticles + param, function (data, status) {
            console.log("data", data)
            console.log("status", status)
            if (status == "success") {
                // json 转换为对象
                // let result = JSON.parse(data)
                let result = data
                let objectData = result["Data"]

                let code = result["Code"]
                if (code == 200) {
                    app.articles = objectData
                }
            }
        })

    }

    initArticle(app)
    //  表单回显原始数据
    let echoFormData = (that) => {
        // 根据id获取文章原数据
        let article = {}
        // 获取articleId 从元素上
        // ajax 获取单个文章数据
        let id = $(that).attr('article-id')
        var param = `/${id}`
        $.ajax({
            type: "get",
            url: getOneArticle + param,
            async: false,
            success: function (data, status) {
                console.log("data", data)
                console.log("status", status)
                if (status == "success") {
                    let result = data
                    let objectData = result["Data"]
                    console.log("objectData", objectData)
                    let code = result["Code"]
                    if (code == 200) {
                        article = objectData
                    }
                }
            }
        });

        // 给saveButton加上id
        $('#saveButton').attr('article-id', id)
        // const mockArticle = {
        //     "article_title": "标题",
        //     "article_simple_content": "描述文章",
        //     "article_author": "原创",
        //     "type_id": 2,
        // }

        $('#article_title').attr('value', article.article_title)
        $('#article_simple_content').attr('value', article.article_simple_content)
        $('#article_author').attr('value', article.article_author)
        $('#type_id').val(article.type_id)
    }

    let modifyArticle = () => {
        // ajax 调用保存文章
        let id = $('#saveButton').attr('article-id')
        let requestData = {
            "id": id,
            "article_simple_content": $('#article_simple_content').attr('value'),
            "article_title": $('#article_title').attr('value'),
            "type_id": $('#type_id').val(),
            "article_author": $('#article_author').attr('value'),
        }

        // form 构造
        //获取上传文件
        // let file = $("#exampleInputFile").get(0).files[0];
        let formData = new FormData()
        // formData.append("coverImage", file)
        formData.append("ArticleSimpleContent", requestData.article_simple_content)
        formData.append("ArticleTitle", requestData.article_title)
        formData.append("TypeId", requestData.type_id)
        formData.append("ArticleAuthor", requestData.article_author)
        $.ajax({
            type: "post",
            url: modifyArticleForm,
            async: true,
            data: formData,
            contentType: false,//这里必须为false
            processData: false,//这里必须为false
            success: function (data, status) {
                console.log("data", data)
                console.log("status", status)
                if (status == "success") {
                    let result = data
                    let code = result["Code"]
                    if (code == 200) {
                        alert('修改文章成功')
                    }
                }
            }
        })
        $('#myModal').modal('hide')
    }
    let deleteArticle = (that) => {
        var r = confirm("是否删除？");
        if (r == true) {
            let id = $(that).attr('article-id')
            console.log('id', id)
            let param = `/?id=${id}`
            $.get(deleteArticleApi + param, function (data, status) {
                if (status === 'success') {
                    let result = data
                    let code = result["Code"]
                    if (code === 200) {
                        location.reload()
                    }
                }
            })
        }
    }
    function updateCover(that) {
        let id = $(that).attr('article-id')
        $('#coverModal input[name="id"]').val(id)
    }
    // 隐藏修改图片modal
    function hideCoverModal() {
        $('#coverModal').modal('hide')
    }
</script>